package com.sos.jobscheduler;

import java.io.IOException;
import java.io.StringWriter;
import java.net.URISyntaxException;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;

import org.dom4j.DocumentException;
import org.dom4j.DocumentHelper;
import org.junit.Test;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializationFeature;
import com.sos.joc.model.calendar.CalendarType;
import com.sos.joc.model.calendar.Period;
import com.sos.joc.model.plan.RunTime;

import sos.xml.SOSXMLXPath;

public class RunTimeResolverTest {

    @Test
    public void testDateRunTimeResolver() throws Exception {
        String runTime = "<run_time time_zone=\"Europe/Berlin\">\n      <date calendar=\"/test/test4\" date=\"2017-11-16\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-11-22\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-11-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-04\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-07\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-13\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-19\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-25\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-15\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-08\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-14\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-01\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-07\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-13\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-19\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-22\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-12\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-15\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-21\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-11\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-14\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-02\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-11\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-17\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-23\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-01\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-07\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-13\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-16\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-22\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-06\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-12\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-27\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-15\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-08\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-14\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-29\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-11\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-17\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <weekdays>\n         <day  day=\"1 2 3 4 5 6 7\">\n            <period  begin=\"00:00\" end=\"24:00\" repeat=\"00:30\"/>\n         </day>\n      </weekdays>\n</run_time>";
        String dateTo = "2018-12-31";
        String jobSchedulerTimeZone = "Europe/Berlin";
        RunTime rt = new RuntimeResolver().resolveFromToday(new SOSXMLXPath(new StringBuffer(runTime)), dateTo, jobSchedulerTimeZone);
        ObjectMapper om = new ObjectMapper();
        om.enable(SerializationFeature.INDENT_OUTPUT);
        System.out.println(om.writeValueAsString(rt));
    }
    
    @Test
    public void testWeekdayRunTimeResolver() throws Exception {
        String runTime = "<run_time time_zone=\"Europe/Berlin\"><weekdays><day  day=\"1 2 3 4 5 6 7\"><period  begin=\"00:00\" end=\"24:00\" repeat=\"00:30\"/></day></weekdays></run_time>";
        String dateTo = "2018-12-31";
        String jobSchedulerTimeZone = "Europe/Berlin";
        RunTime rt = new RuntimeResolver().resolveFromToday(new SOSXMLXPath(new StringBuffer(runTime)), dateTo, jobSchedulerTimeZone);
        ObjectMapper om = new ObjectMapper();
        om.enable(SerializationFeature.INDENT_OUTPUT);
        System.out.println(om.writeValueAsString(rt));
    }
    
    @Test
    public void getCalendarDatesFromToday() throws Exception {
        String runTime = "<run_time time_zone=\"Europe/Berlin\">\n      <date calendar=\"/test/test4\" date=\"2017-11-16\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-11-22\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-11-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-04\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-07\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-13\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-19\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-25\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-15\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-08\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-14\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-01\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-07\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-13\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-19\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-22\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-12\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-15\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-21\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-11\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-14\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-02\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-11\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-17\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-23\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-01\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-07\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-13\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-16\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-22\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-06\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-12\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-27\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-15\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-08\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-14\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-29\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-11\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-17\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <weekdays>\n         <day  day=\"1 2 3 4 5 6 7\">\n            <period  begin=\"00:00\" end=\"24:00\" repeat=\"00:30\"/>\n         </day>\n      </weekdays>\n</run_time>";
        SOSXMLXPath xPath = new SOSXMLXPath(new StringBuffer(runTime));
        String timeZone = xPath.getRoot().getAttribute("time_zone");
        Collection<RuntimeCalendar> calendars = RuntimeResolver.getCalendarDatesFromToday(xPath, xPath.getRoot(), timeZone);
        ObjectMapper om = new ObjectMapper();
        calendars.forEach(cal -> {
            try {
                System.out.println(om.writeValueAsString(cal));
            } catch (JsonProcessingException e) {
                throw new RuntimeException(e);
            }
        });
    }
    
    @Test
    public void getCalendarDatesFromToday2() throws Exception {
        String runTime = "<run_time time_zone=\"Europe/Berlin\">\n      <date calendar=\"/test/test4\" date=\"2017-11-16\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-11-22\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-11-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-04\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-07\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-13\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-19\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-25\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2017-12-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-15\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-01-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-08\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-14\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-02-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-01\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-07\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-13\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-19\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-22\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-03-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-12\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-04-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-15\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-21\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-05-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-11\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-14\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-06-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-02\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-11\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-17\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-23\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-07-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-01\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-07\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-13\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-16\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-22\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-08-28\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-06\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-12\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-09-27\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-03\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-09\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-15\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-18\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-24\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-10-30\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-08\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-14\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-11-29\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-05\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-11\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-17\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-20\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <date calendar=\"/test/test4\" date=\"2018-12-26\">\n         <period single_start=\"01:00:00\"/>\n      </date>\n      <weekdays>\n         <day  day=\"1 2 3 4 5 6 7\">\n            <period  begin=\"00:00\" end=\"24:00\" repeat=\"00:30\"/>\n         </day>\n      </weekdays>\n</run_time>";
        Collection<RuntimeCalendar> calendars = RuntimeResolver.getCalendarDatesFromToday(DocumentHelper.parseText(runTime).getRootElement(), "Asia/Tokyo");
        ObjectMapper om = new ObjectMapper();
        calendars.forEach(cal -> {
            try {
                System.out.println(om.writeValueAsString(cal));
            } catch (JsonProcessingException e) {
                throw new RuntimeException(e);
            }
        });
    }
    
    @Test
    public void test() throws DocumentException, IOException, URISyntaxException {
        StringWriter writer = new StringWriter();
        
        RuntimeCalendar rc = new RuntimeCalendar();
        rc.setPath("/test/calendar");
        List<String> dates = new ArrayList<String>();
        dates.add("2018-10-09");
        dates.add("2018-11-09");
        rc.setDates(dates);
        rc.setType(CalendarType.WORKING_DAYS);
        List<Period> periods = new ArrayList<Period>();
        Period period = new Period();
        period.setSingleStart("12:00");
        periods.add(period);
        rc.setPeriods(periods);
        
        RuntimeCalendar rc2 = new RuntimeCalendar();
        rc2.setPath("/test/calendar2");
        List<String> dates2 = new ArrayList<String>();
        dates2.add("2018-10-03");
        rc2.setDates(dates2);
        rc2.setType(CalendarType.NON_WORKING_DAYS);
        
        List<RuntimeCalendar> calendars = new ArrayList<RuntimeCalendar>();
        calendars.add(rc);
        calendars.add(rc2);
        
        RuntimeResolver.updateCalendarInRuntimes(Paths.get(this.getClass().getResource("test.job.xml").toURI()), writer, calendars);
        
        System.out.println(writer.toString());
    }

}
